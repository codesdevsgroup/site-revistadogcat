<div class="usuarios-container">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-users"></i>
      Usuários
    </h1>
    <div class="page-actions">
      <!-- Botão para abrir o modal em modo de adição -->
      <button class="btn btn-primary" (click)="openModal()">
        <i class="fas fa-plus"></i>
        Novo Usuário
      </button>
    </div>
  </div>

  <!-- Container principal que aguarda a resolução do Observable -->
  <ng-container *ngIf="usuarios$ | async as usuarios; else loadingOrError">
    <div class="usuarios-table-container">
      <div class="table-header">
        <h2>Lista de Usuários ({{ usuarios.length }})</h2>
        <div class="table-filters">
          <!-- Campo de busca conectado ao FormControl -->
          <input
            type="text"
            placeholder="Buscar por nome, email ou CPF..."
            class="search-input"
            [formControl]="searchControl">

          <!-- Seletor de role conectado ao FormControl -->
          <select class="filter-select" [formControl]="roleControl">
            <option value="">Todos os tipos</option>
            <option value="ADMIN">Admin</option>
            <option value="EDITOR">Editor</option>
            <option value="FUNCIONARIO">Funcionário</option>
            <option value="ASSINANTE">Assinante</option>
            <option value="DONO_PET_APROVADO_ASSINANTE">Dono de Pet (Assinante)</option>
            <option value="DONO_PET_APROVADO">Dono de Pet</option>
            <option value="USUARIO">Usuário Comum</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="usuarios-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Email</th>
              <th>Tipo (Role)</th>
              <th>Status</th>
              <th>Data Cadastro</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of usuarios; trackBy: trackByUserId" class="table-row">
              <td class="user-id">#{{ usuario.userId.substring(0, 8) }}...</td>
              <td class="user-name">
                <div class="user-info">
                  <div class="user-avatar">
                    <img *ngIf="usuario.avatarUrl; else defaultAvatar" [src]="usuario.avatarUrl" alt="Avatar de {{usuario.name}}" class="avatar-image">
                    <ng-template #defaultAvatar>
                      <i class="fas fa-user"></i>
                    </ng-template>
                  </div>
                  <span>{{ usuario.name }}</span>
                </div>
              </td>
              <td class="user-email">{{ usuario.email }}</td>
              <td class="user-tipo">
                <span class="badge" [ngClass]="getRoleClass(usuario.role)">
                  {{ usuario.role }}
                </span>
              </td>
              <td class="user-status">
                <span class="status-indicator" [ngClass]="getStatusClass(usuario.active)">
                  <i class="fas" [ngClass]="usuario.active ? 'fa-check-circle' : 'fa-times-circle'"></i>
                  {{ usuario.active ? 'Ativo' : 'Inativo' }}
                </span>
              </td>
              <td class="user-date">{{ usuario.createdAt | date:'dd/MM/yyyy' }}</td>
              <td class="user-actions">
                <div class="action-buttons">
                  <!-- Botão para abrir o modal em modo de edição -->
                  <button class="btn-action btn-edit" (click)="openModal(usuario)" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-action btn-delete" (click)="excluirUsuario(usuario)" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="usuarios.length === 0" class="empty-state">
        <i class="fas fa-user-slash"></i>
        <p>Nenhum usuário encontrado.</p>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingOrError>
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Carregando usuários...</p>
    </div>
  </ng-template>

</div>

<!-- Componente do Modal -->
<app-usuario-modal
  [isVisible]="isModalVisible"
  [usuario]="selectedUsuario"
  (close)="closeModal()"
  (save)="handleSave($event)">
</app-usuario-modal>
