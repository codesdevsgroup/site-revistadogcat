<div class="caes-container">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-dog"></i>
      Cães Cadastrados
    </h1>
    <div class="page-actions">
      <button
        class="btn btn-secondary"
        (click)="openBreedModal()"
        *ngIf="canManageBreeds()"
      >
        <i class="fas fa-cog"></i>
        Gerenciar Raças
      </button>
      <button class="btn btn-primary" (click)="navigateToCadastro()">
        <i class="fas fa-plus"></i>
        Cadastrar Cão
      </button>
    </div>
  </div>

  <ng-container *ngIf="!isLoading; else loadingTemplate">
    <div class="caes-table-container">
      <div class="table-header">
        <h2>Lista de Cães ({{ filteredCaes.length }})</h2>
        <div class="table-filters">
          <input
            type="text"
            placeholder="Buscar por nome, dono ou registro..."
            class="search-input"
            [(ngModel)]="searchTerm"
          />

          <select class="filter-select" [(ngModel)]="selectedRaca">
            <option value="">Todas as raças</option>
            <option *ngFor="let raca of racas" [value]="raca.id">
              {{ raca.nome }}
            </option>
          </select>

          <select
            class="filter-select"
            [(ngModel)]="selectedStatus"
            (change)="loadCaes()"
          >
            <option *ngFor="let status of statuses" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>
      </div>

      <div
        class="table-responsive"
        *ngIf="filteredCaes.length > 0; else emptyState"
      >
        <table class="caes-table">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nome</th>
              <th>Raça</th>
              <th>Idade</th>
              <th>Sexo</th>
              <th>Dono</th>
              <th>Data de Cadastro</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cao of filteredCaes">
              <td>
                <div class="cao-photo">
                  <img *ngIf="cao.fotos && cao.fotos.length > 0; else noPhoto"
                       [src]="cao.fotos[0]"
                       [alt]="cao.nome"
                       class="photo-thumbnail">
                  <ng-template #noPhoto>
                    <div class="no-photo">
                      <i class="fas fa-dog"></i>
                    </div>
                  </ng-template>
                </div>
              </td>
              <td>
                <div class="cao-name">
                  <strong>{{ cao.nome }}</strong>
                  <span *ngIf="isCaoPendente(cao)" class="badge bg-warning ms-1"
                    >Cadastro incompleto</span
                  >
                  <small *ngIf="cao.numeroRegistro"
                    >#{{ cao.numeroRegistro }}</small
                  >
                </div>
              </td>
              <td>{{ getRacaName(cao.racaId) }}</td>
              <td>{{ formatAge(cao.dataNascimento) }}</td>
              <td>
                <span class="sexo-badge" [class]="cao.sexo.toLowerCase()">
                  {{ cao.sexo === 'MACHO' ? 'Macho' : 'Fêmea' }}
                </span>
              </td>
              <td>{{ cao.donoCao?.nome || 'N/A' }}</td>
              <td>{{ formatDate(cao.createdAt) }}</td>
              <td>
                <div class="action-buttons">
                  <button
                    class="btn btn-sm btn-outline"
                    (click)="openCaoModal(cao)"
                    title="Detalhes"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    *ngIf="isCaoPendente(cao)"
                    class="btn btn-sm btn-success ms-1"
                    (click)="aprovarCao(cao)"
                    title="Aprovar"
                  >
                    <i class="fas fa-check"></i>
                  </button>
                  <button
                    *ngIf="isCaoPendente(cao)"
                    class="btn btn-sm btn-warning ms-1"
                    (click)="rejeitarCao(cao)"
                    title="Rejeitar"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #emptyState>
        <div class="empty-state">
          <i class="fas fa-dog"></i>
          <h3>Nenhum cão encontrado</h3>
          <p *ngIf="searchTerm || selectedBreedId">
            Tente ajustar os filtros de busca ou
            <button class="btn-link" (click)="clearFilters()">
              limpar filtros
            </button>
          </p>
          <p *ngIf="!searchTerm && !selectedBreedId">
            Ainda não há cães cadastrados no sistema.
          </p>
        </div>
      </ng-template>
    </div>
  </ng-container>

  <ng-template #loadingTemplate>
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando cães...</p>
    </div>
  </ng-template>
</div>

<div class="modal-overlay" *ngIf="showBreedModal" (click)="closeBreedModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-cog"></i>
        Gerenciar Raças
      </h3>
      <button class="btn-close" (click)="closeBreedModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <form class="breed-form" (ngSubmit)="saveBreed()" #breedForm="ngForm">
        <div class="form-group">
          <label for="breedName">Nome da Raça</label>
          <input
            type="text"
            id="breedName"
            name="breedName"
            class="form-control"
            [(ngModel)]="currentBreed.nome"
            required
            placeholder="Digite o nome da raça"
          />
        </div>

        <div class="form-group">
          <label for="breedDescription">Descrição</label>
          <textarea
            id="breedDescription"
            name="breedDescription"
            class="form-control"
            [(ngModel)]="currentBreed.descricao"
            rows="3"
            placeholder="Descrição da raça (opcional)"
          ></textarea>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelBreedEdit()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!breedForm.valid || isSavingBreed"
          >
            <i class="fas fa-spinner fa-spin" *ngIf="isSavingBreed"></i>
            {{ editingBreedId ? 'Atualizar' : 'Adicionar' }}
          </button>
        </div>
      </form>

      <!-- Lista de raças existentes -->
      <div class="breeds-list" *ngIf="racas.length > 0">
        <div class="breeds-header">
          <h4>Raças Cadastradas</h4>
          <div class="breeds-filter">
            <input
              type="text"
              class="form-control form-control-sm"
              [(ngModel)]="racaSearchTerm"
              placeholder="Filtrar raças..."
              (input)="onRacaFilterChange()"
            />
            <i class="fas fa-search"></i>
          </div>
        </div>

        <div class="breed-item" *ngFor="let raca of filteredRacas">
          <div class="breed-info">
            <strong>{{ raca.nome }}</strong>
            <small *ngIf="raca.descricao">{{ raca.descricao }}</small>
          </div>
          <div class="breed-actions">
            <button
              class="btn btn-sm btn-outline"
              (click)="editBreed(raca)"
              title="Editar"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteBreed(raca)"
              title="Excluir"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div
          class="no-results"
          *ngIf="filteredRacas.length === 0 && racaSearchTerm"
        >
          <p>Nenhuma raça encontrada para "{{ racaSearchTerm }}"</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Visualizar/Editar Cão -->
<div class="modal-overlay" *ngIf="showCaoModal" (click)="closeCaoModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-dog"></i>
        Detalhes do Cão
      </h3>
      <button class="btn-close" (click)="closeCaoModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedCao">
      <div class="gallery">
        <h4>Fotos</h4>
        <div class="thumbnail-container">
          <div class="thumbnail" *ngFor="let foto of selectedCao.fotos">
            <img [src]="foto" [alt]="selectedCao.nome">
          </div>
          <div class="thumbnail" *ngIf="selectedCao.pedigreeFrente">
            <img [src]="selectedCao.pedigreeFrente" alt="Pedigree (Frente)">
            <small>Pedigree Frente</small>
          </div>
          <div class="thumbnail" *ngIf="selectedCao.pedigreeVerso">
            <img [src]="selectedCao.pedigreeVerso" alt="Pedigree (Verso)">
            <small>Pedigree Verso</small>
          </div>
        </div>
      </div>

      <div class="cao-details">
        <!-- Detalhes do Cão -->
        <div class="cao-info">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" class="form-control" [(ngModel)]="selectedCao.nome" [disabled]="!isEditingCao">
          </div>

          <div class="form-group">
            <label>Raça</label>
            <select class="form-control" [(ngModel)]="selectedCao.racaId" [disabled]="!isEditingCao">
              <option *ngFor="let raca of racas" [value]="raca.id">{{ raca.nome }}</option>
            </select>
          </div>

          <div class="form-group">
            <label>Data de Nascimento</label>
            <input type="date" class="form-control" [ngModel]="selectedCao.dataNascimento | date:'yyyy-MM-dd'" (ngModelChange)="selectedCao.dataNascimento = $event" [disabled]="!isEditingCao">
          </div>

          <div class="form-group">
            <label>Sexo</label>
            <select class="form-control" [(ngModel)]="selectedCao.sexo" [disabled]="!isEditingCao">
              <option value="MACHO">Macho</option>
              <option value="FEMEA">Fêmea</option>
            </select>
          </div>

          <div class="form-group">
            <label>Dono</label>
            <input type="text" class="form-control" [value]="selectedCao.donoCao?.nome || 'N/A'" disabled>
          </div>

          <div class="form-group">
            <label>Nº de Registro</label>
            <input type="text" class="form-control" [(ngModel)]="selectedCao.numeroRegistro" [disabled]="!isEditingCao">
          </div>

          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="temPedigree" [(ngModel)]="selectedCao.temPedigree" [disabled]="!isEditingCao">
            <label class="form-check-label" for="temPedigree">Possui Pedigree</label>
          </div>

          <div class="form-group" *ngIf="selectedCao.temPedigree">
            <label>Registro do Pedigree</label>
            <input type="text" class="form-control" [(ngModel)]="selectedCao.registroPedigree" [disabled]="!isEditingCao">
          </div>

          <div class="form-group">
            <label>Opção de Vídeo</label>
            <select class="form-control" [(ngModel)]="selectedCao.videoOption" [disabled]="!isEditingCao">
              <option *ngFor="let option of videoOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>

          <div class="form-group" *ngIf="selectedCao.videoOption === 'URL'">
            <label>URL do Vídeo</label>
            <input type="text" class="form-control" [(ngModel)]="selectedCao.videoUrl" [disabled]="!isEditingCao">
          </div>

          <div class="form-group" *ngIf="selectedCao.videoOption === 'UPLOAD'">
            <label>Arquivo de Vídeo</label>
            <input type="file" class="form-control" (change)="onFileSelected($event)" [disabled]="!isEditingCao" accept="video/*">
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeCaoModal()">
        {{ isEditingCao ? 'Cancelar' : 'Fechar' }}
      </button>
      <button
        type="button"
        class="btn btn-primary"
        *ngIf="!isEditingCao"
        (click)="isEditingCao = true"
      >
        <i class="fas fa-edit"></i>
        Editar
      </button>
      <button
        type="button"
        class="btn btn-success"
        *ngIf="isEditingCao"
        (click)="saveCao()"
      >
        <i class="fas fa-save"></i>
        Salvar
      </button>
    </div>
  </div>
</div>
