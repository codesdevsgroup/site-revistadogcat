<div class="caes-container">
  <div class="page-header">
    <h1 class="page-title">
      <i class="pi pi-paw"></i>
      Cães Cadastrados
    </h1>
    <div class="page-actions">
      <button pButton type="button" icon="pi pi-cog" label="Gerenciar Raças"
        (click)="openBreedModal()"
        *ngIf="canManageBreeds()"
      ></button>
      <button pButton type="button" icon="pi pi-plus" label="Cadastrar Cão" (click)="navigateToCadastro()"></button>
    </div>
  </div>

  <ng-container *ngIf="!isLoading; else loadingTemplate">
    <div class="caes-table-container">
      <div class="table-header">
        <h2>Lista de Cães ({{ filteredCaes.length }})</h2>
        <div class="table-filters">
          <input pInputText type="text" placeholder="Buscar por nome, dono ou registro..." class="search-input" (input)="dt.filterGlobal($any($event.target).value, 'contains')" />

          <p-select [options]="racas" optionLabel="nome" optionValue="id" placeholder="Todas as raças" (onChange)="dt.filter($event.value, 'racaId', 'equals')" appendTo="body"></p-select>

          <p-select [options]="statuses" optionLabel="label" optionValue="value" placeholder="Todos os status" (onChange)="dt.filter($event.value, 'status', 'equals')" appendTo="body"></p-select>
        </div>
      </div>

      <p-table #dt [value]="filteredCaes" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10,20,50]" sortMode="multiple" [tableStyle]="{'min-width':'70rem'}" [globalFilterFields]="['nome','numeroRegistro','donoCao.nome']" dataKey="cadastroId" [paginatorDropdownAppendTo]="'body'">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="nome">Nome <p-sortIcon field="nome"></p-sortIcon></th>
            <th pSortableColumn="racaId">Raça <p-sortIcon field="racaId"></p-sortIcon></th>
            <th pSortableColumn="dataNascimento">Idade <p-sortIcon field="dataNascimento"></p-sortIcon></th>
            <th pSortableColumn="sexo">Sexo <p-sortIcon field="sexo"></p-sortIcon></th>
            <th pSortableColumn="donoCao.nome">Dono <p-sortIcon field="donoCao.nome"></p-sortIcon></th>
            <th pSortableColumn="createdAt">Data de Cadastro <p-sortIcon field="createdAt"></p-sortIcon></th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-cao>
          <tr>
            <td>
              <div class="cao-name">
                <strong>{{ cao.nome }}</strong>
                <span *ngIf="isCaoPendente(cao)" class="badge bg-warning ms-1">Cadastro incompleto</span>
                <small *ngIf="cao.numeroRegistro">#{{ cao.numeroRegistro }}</small>
              </div>
            </td>
            <td>{{ getRacaName(cao.racaId) }}</td>
            <td>{{ formatAge(cao.dataNascimento) }}</td>
            <td>
              <span class="sexo-badge" [class]="cao.sexo.toLowerCase()">{{ cao.sexo === 'MACHO' ? 'Macho' : 'Fêmea' }}</span>
            </td>
            <td>{{ cao.donoCao?.nome || 'N/A' }}</td>
            <td>{{ formatDate(cao.createdAt) }}</td>
            <td>
              <p-select
                [options]="statusOptions"
                optionLabel="label"
                optionValue="value"
                [(ngModel)]="cao.status"
                (onChange)="onRowStatusChange(cao, $event.value)"
                placeholder="Selecionar"
                appendTo="body"
              ></p-select>
            </td>
            <td>
              <div class="action-buttons">
                <button pButton type="button" icon="pi pi-eye" class="p-button-rounded p-button-text" (click)="openCaoModal(cao)" title="Visualizar"></button>
                <button pButton type="button" icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editCao(cao)" title="Editar"></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <ng-template #emptyState>
        <div class="empty-state">
          <i class="fas fa-dog"></i>
          <h3>Nenhum cão encontrado</h3>
          <p *ngIf="searchTerm || selectedBreedId">
            Tente ajustar os filtros de busca ou
            <button class="btn-link" (click)="clearFilters()">
              limpar filtros
            </button>
          </p>
          <p *ngIf="!searchTerm && !selectedBreedId">
            Ainda não há cães cadastrados no sistema.
          </p>
        </div>
      </ng-template>
    </div>
  </ng-container>

  <ng-template #loadingTemplate>
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando cães...</p>
    </div>
  </ng-template>
</div>

<app-raca-manage-dialog
  [visible]="showRacaModal"
  (visibleChange)="showRacaModal = $event"
  [racas]="racas"
  [currentBreed]="currentBreed"
  [isSavingBreed]="isSavingBreed"
  [editingBreedId]="editingBreedId"
  [racaSearchTerm]="racaSearchTerm"
  (racaSearchTermChange)="racaSearchTerm = $event; onRacaFilterChange()"
  (cancel)="cancelBreedEdit()"
  (save)="saveBreed()"
  (edit)="editBreed($event)"
  (delete)="deleteBreed($event)"
></app-raca-manage-dialog>

<app-cao-details-dialog
  [visible]="showCaoModal"
  [cao]="selectedCao"
  [racas]="racas"
  (visibleChange)="showCaoModal = $event"
  (save)="saveCao($event)"
  (cancel)="closeCaoModal()"
></app-cao-details-dialog>
