<!-- Modal Backdrop -->
<div class="modal-backdrop" *ngIf="isOpen" (click)="onClose()"></div>

<!-- Modal -->
<div class="modal profile-edit-modal" [class.show]="isOpen" *ngIf="isOpen">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
        <!-- Modal Header -->
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-user-edit me-2"></i>
            Editar Perfil
          </h5>
          <button type="button" class="btn-close" (click)="onClose()" [disabled]="loading"></button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <!-- Alerts -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
          </div>
          
          <div *ngIf="success" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ success }}
          </div>

          <!-- Avatar Section -->
          <div class="avatar-section mb-4">
            <h6 class="section-title">
              <i class="fas fa-camera me-2"></i>
              Foto de Perfil
            </h6>
            <div class="avatar-upload-container">
              <div class="current-avatar">
                <img 
                  [src]="avatarPreview || user?.avatarUrl || '/assets/default-avatar.png'" 
                  alt="Avatar" 
                  class="avatar-preview"
                >
                <div *ngIf="uploadingAvatar" class="avatar-loading">
                  <div class="spinner-border spinner-border-sm text-light" role="status">
                    <span class="visually-hidden">Enviando...</span>
                  </div>
                </div>
              </div>
              <div class="avatar-controls">
                <input 
                  type="file" 
                  id="avatar-input" 
                  accept="image/jpeg,image/jpg,image/png,image/webp" 
                  (change)="onAvatarSelected($event)"
                  class="d-none"
                >
                <label for="avatar-input" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-upload me-1"></i>
                  Escolher Foto
                </label>
                <small class="text-muted d-block mt-1">
                  JPG, PNG ou WebP. Máximo 5MB.
                </small>
              </div>
            </div>
          </div>

          <!-- Personal Information -->
          <div class="personal-info-section">
            <h6 class="section-title">
              <i class="fas fa-user me-2"></i>
              Informações Pessoais
            </h6>
            
            <div class="row">
              <!-- Nome Completo -->
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Nome Completo *</label>
                <input 
                  type="text" 
                  id="name" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('name')"
                  formControlName="name"
                  placeholder="Digite seu nome completo"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('name')">
                  {{ getFieldError('name') }}
                </div>
              </div>

              <!-- Nome de Usuário -->
              <div class="col-md-6 mb-3">
                <label for="userName" class="form-label">Nome de Usuário *</label>
                <input 
                  type="text" 
                  id="userName" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('userName')"
                  formControlName="userName"
                  placeholder="Digite seu nome de usuário"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('userName')">
                  {{ getFieldError('userName') }}
                </div>
              </div>

              <!-- E-mail -->
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">E-mail *</label>
                <input 
                  type="email" 
                  id="email" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('email')"
                  formControlName="email"
                  placeholder="Digite seu e-mail"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
                  {{ getFieldError('email') }}
                </div>
              </div>

              <!-- Telefone -->
              <div class="col-md-6 mb-3">
                <label for="telefone" class="form-label">Telefone</label>
                <input 
                  type="text" 
                  id="telefone" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('telefone')"
                  formControlName="telefone"
                  placeholder="(00) 00000-0000"
                  (input)="onTelefoneInput($event)"
                  maxlength="15"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('telefone')">
                  {{ getFieldError('telefone') }}
                </div>
              </div>

              <!-- CPF -->
              <div class="col-md-6 mb-3">
                <label for="cpf" class="form-label">CPF</label>
                <input 
                  type="text" 
                  id="cpf" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('cpf')"
                  formControlName="cpf"
                  placeholder="000.000.000-00"
                  (input)="onCpfInput($event)"
                  maxlength="14"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('cpf')">
                  {{ getFieldError('cpf') }}
                </div>
              </div>

              <!-- Data de Nascimento -->
              <div class="col-md-6 mb-3">
                <label for="birthDate" class="form-label">Data de Nascimento</label>
                <input 
                  type="date" 
                  id="birthDate" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('birthDate')"
                  formControlName="birthDate"
                >
                <div class="invalid-feedback" *ngIf="isFieldInvalid('birthDate')">
                  {{ getFieldError('birthDate') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="onClose()"
            [disabled]="loading"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="loading || profileForm.invalid"
          >
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Salvando...</span>
            </span>
            <i *ngIf="!loading" class="fas fa-save me-2"></i>
            {{ loading ? 'Salvando...' : 'Salvar Alterações' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>